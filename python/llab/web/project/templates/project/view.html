{% extends "project/base.html" %}

{% load bootstrap3 %}
{% load humanize %}
{% load gravatar %}
{% load staticfiles %}
{% load project_extras %}

{% block "project_content" %}
<div class="row">
  <div class="col-md-10 center-block no-float">
    <h3>
      <small class="gray-light pad-right-10">
      {% if project.private %}
      PRIVATE
      {% else %}
      PUBLIC
      {% endif %}
      <span class="glyphicon glyphicon-book"></span>
      </small>
      <a href="#">{{ project.owner.username }}</a> /
      <strong><a href="#">{{ project.name }}</a></strong>
    </h3>

    <hr>

    <h4 class="gray-light">{{ project.description }} - <a href="#">Edit</a></h4>

    <br>

    <ul class="nav nav-tabs">
      <li class="active">
        <a data-toggle="tab" href="#tab-source">
          <span class="glyphicon glyphicon-book"></span>
          <strong>Source</strong>
        </a>
      </li>

      <li>
        <a data-toggle="tab" href="#tab-commits">
          <span class="glyphicon glyphicon-list"></span>
          <strong>{{ commit_count }}</strong> Commit{{ commit_count|pluralize }}
        </a>
      </li>

      <li>
        <a data-toggle="tab" href="#tab-branches">
          <span class="glyphicon glyphicon-tree-conifer"></span>
          <strong>{{ branch_count }}</strong> Branch{{ branch_count|pluralize:"es" }}
        </a>
      </li>

      <li>
        <a data-toggle="tab" href="#tab-tags">
          <span class="glyphicon glyphicon-calendar"></span>
          <strong>{{ tag_count }}</strong> Tag{{ tag_count|pluralize }}
        </a>
      </li>

      <li>
        <a data-toggle="tab" href="#tab-contributors">
          <span class="glyphicon glyphicon-globe"></span>
          <strong>{{ contributor_count }}</strong> Contributor{{ contributor_count|pluralize }}
        </a>
      </li>

      <li>
        <a data-toggle="tab" href="#tab-issues">
          <span class="glyphicon glyphicon-wrench"></span>
          0 Issues
        </a>
      </li>

      {% if user_is_admin %}
      <li>
        <a data-toggle="admin" href="#tab-issues">
          <span class="glyphicon glyphicon-cog"></span>
          Settings
        </a>
      </li>
      {% endif %}
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="tab-source">
        <h4>
          <div class="btn-group">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
              <span class="glyphicon glyphicon-tree-conifer"></span> branch: {{ commit.branch.short_name }}
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
              {% for branch in project.branches.all %}
              <li><a href="#">{{ branch.short_name }}</a></li>
              {% endfor %}
            </ul>
          </div>
          <span id="source-tree-breadcrumb">
              <a href="#">{{ current_path }}</a> /
          </span>
        </h4>
        <div class="panel panel-primary">
          <div class="panel-body">
            {{ commit.short_message }}
            <br>
            {% gravatar commit.author.gravatar 16 g %}
            <a href="#">{{ commit.author.username }}</a> <span class="gray-light">authored {{ commit.created|naturaltime }}
              on <a href="#">{{ commit.short_sha1sum }}</a></span>
          </div>
          <table class="table table-hover table-condensed table-bordered table-striped">
            <tbody id="source-tree">
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane" id="tab-commits">
        <h3>Commits</h3>
        <div class="alert alert-danger">
          <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" title="The developers have not implemented this feature."></span>
          Check back soon. This feature will allow you to view a breakdown of all your commits.
        </div>
      </div>

      <div class="tab-pane" id="tab-branches">
        <h3>Branches</h3>
        <div class="alert alert-danger">
          <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" title="The developers have not implemented this feature."></span>
          Check back soon. This feature will allow you to view a breakdown of all your branches.
        </div>
      </div>

      <div class="tab-pane" id="tab-tags">
        <h3>Tags</h3>
        <div class="alert alert-danger">
          <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" title="The developers have not implemented this feature."></span>
          Check back soon. This feature will allow you to view a breakdown of all your tags.
        </div>
      </div>

      <div class="tab-pane" id="tab-contributors">
        <h3>Contributors</h3>
        <div class="alert alert-danger">
          <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" title="The developers have not implemented this feature."></span>
          Check back soon. This feature will allow you to see your project contributors.
        </div>
      </div>

      <div class="tab-pane" id="tab-issues">
        <h3>Issues</h3>
        <div class="alert alert-danger">
          <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" title="The developers have not implemented this feature."></span>
          Check back soon. This feature will allow you to manage your project's issues.
        </div>
      </div>

      {% if user_is_admin %}
      <div class="tab-pane" id="tab-settings">
        <h3>Settings</h3>
        <div class="alert alert-danger">
          <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" title="The developers have not implemented this feature."></span>
          Check back soon. This feature will allow you to manage your projects.
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
/* DEBUG CODE
 * This is my prototyping area for tree traversal.
 */
$.getJSON('{% url "project:tree" project=project.name owner=project.owner.username commit=commit.sha1sum path="/" %}',
function (full_tree) {
    var $tree = $('#source-tree');
    var $breadcrumb = $('#source-tree-breadcrumb');
    var prev_tree = [];
    var prev_tree_path = ['llab'];
    var curr_tree = full_tree;
    var tree_path = 'tree/{{ commit.branch.short_name }}/';
    var initial_path = {{ path|safe }};

    var build_tree = function (tree) {
        $tree.html('');

        if (prev_tree.length) {
            var record = '<tr>';
            record += '<td class="prev-tree">' + '<span class="text-primary link">../</span>' +'</td>';
            record += '<td></td>';
            record += '<td></td>';
            record += '</tr>';
            $tree.append($(record));
        }

        for (var item in tree) {
            var obj = tree[item];
            var item_name = item
            var item_type = obj['type'];
            var item_tree = obj['tree'];
            var item_message = obj['commit']['message']
            var item_time = obj['commit']['commit_time']
            var item_email = obj['commit']['committer_email']

            // Construct the appropriate URL
            var url = '#';
            var item_url = '<a href="' + url + '">' + item_name + '</a>';

            // Construct the appropriate glyph
            var glyph = 'glyphicon-file';
            if (item_type == 'folder') {
                glyph = 'glyphicon-folder-close';
                item_url = '<span class="text-primary link">' + item_name + '</span>';
            }
            glyph = '<span class="glyphicon ' + glyph + '"></span>&nbsp;';

            // Construct the record
            var record = '<tr>';
            record += '<td class="' + item_type + '" data-name="' + item_name + '">' + glyph + item_url + '</td>';
            record += '<td>' + item_message + '</td>';
            record += '<td>' + item_time + '</td>';
            record += '</tr>';

            $tree.append($(record));
        }

        $('td.prev-tree > span').click(function () {
            history.back();
            curr_tree = prev_tree.pop()
            prev_tree_path.pop();
            build_tree(curr_tree);
            return false;
        });

        $('td.folder > span').click(function () {
            var item_name = $(this).parent().data('name');
            prev_tree.push(curr_tree);
            prev_tree_path.push(item_name);
            curr_tree = curr_tree[item_name].tree;
            build_tree(curr_tree);
            if (prev_tree.length == 1) {
                item_name = tree_path + item_name;
            }
            history.pushState({}, '', item_name + '/');
            return false;
        });
    };

    for (var i = 0; i < initial_path.length; i++) {
        var name = initial_path[i];
        if (curr_tree[name] && curr_tree[name].type == "folder") {
            prev_tree.push(curr_tree);
            prev_tree_path.push(name);
            curr_tree = curr_tree[name].tree;
        }
    }

    build_tree(curr_tree);
});
</script>
{% endblock %}
